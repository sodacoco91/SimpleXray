name: "Test Debug Build"

# 触发条件：只要你提交代码 (push) 或者手动点击 (workflow_dispatch) 就会运行
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Explicit Submodule Update
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Android SDK
        id: setup_sdk
        uses: android-actions/setup-android@v3

      # 读取版本号配置，用于后续下载对应版本的内核
      - name: Read Versions
        run: |
          echo "XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOIP_VERSION=$(grep 'GEOIP_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOSITE_VERSION=$(grep 'GEOSITE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      # 下载路由规则文件
      - name: Download Rules Files
        run: |
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOIP_VERSION }}/geoip.dat -O ./app/src/main/assets/geoip.dat
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOSITE_VERSION }}/geosite.dat -O ./app/src/main/assets/geosite.dat

      # 编译 Xray 内核 (这是最关键的一步，保留原项目的逻辑)
      - name: Build Xray-core from Source
        run: |
          # Set up NDK
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)

          # Clone Xray-core source and checkout tag
          git clone https://github.com/XTLS/Xray-core.git
          cd Xray-core
          git checkout ${{ env.XRAY_VERSION }}
          COMMID=$(git rev-parse HEAD | cut -c 1-7)

          export GOOS=android
          export CGO_ENABLED=1

          # Build for arm64-v8a (现代手机主要是这个架构)
          echo "Building for arm64-v8a..."
          export GOARCH=arm64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/arm64-v8a
          mv xray ../app/src/main/jniLibs/arm64-v8a/libxray.so

          # Build for x86_64 (模拟器或Chromebook用)
          echo "Building for x86_64..."
          export GOARCH=amd64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/x86_64
          mv xray ../app/src/main/jniLibs/x86_64/libxray.so

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 关键修改：使用 assembleDebug 而不是 assembleRelease，无需签名密钥
      - name: Build Debug APK
        run: ./gradlew assembleDebug

      # 收集生成的 APK 文件
      - name: Find and Copy APKs
        run: |
          mkdir -p apks
          # Debug 版的输出路径通常在这里
          find app/build/outputs/apk/debug -name "*.apk" -exec cp {} apks/ \;

      # 上传到 GitHub Actions 页面供下载
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplexray-debug-apk
          path: apks/
          if-no-files-found: error
          retention-days: 3